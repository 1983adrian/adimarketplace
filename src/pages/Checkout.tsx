import React, { useState, useEffect } from 'react';import { useNavigate, useSearchParams, Link } from 'react-router-dom';import { z } from 'zod';import {  CreditCard, Lock, Truck, MapPin, ChevronLeft,
  Check, ShieldCheck, Package, Loader2, Trash2, Banknote} from 'lucide-react';import { Layout } from '@/components/layout/Layout';import { Button } from '@/components/ui/button';import { Input } from '@/components/ui/input';import { Label } from '@/components/ui/label';import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';import { Separator } from '@/components/ui/separator';import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';import { Checkbox } from '@/components/ui/checkbox';import { Badge } from '@/components/ui/badge';import { useAuth } from '@/contexts/AuthContext';import { useCart } from '@/contexts/CartContext';import { useToast } from '@/hooks/use-toast';import { useListing...
buyerFee: isCOD ? codFeeTotal : buyerFee,          guestEmail: !user ? shipping.email : undefined,          paymentMethod: paymentMethod,          courier: isCOD ? selectedCourier : undefined,          codFees: isCOD ? codFees : undefined,          // Include card verification info for card payments          cardVerification: paymentMethod === 'card' ? {            cardNumber: cardInfo.cardNumber,
            expiryDate: cardInfo.expiryDate,
            cvv: cardInfo.cvv,
            cardHolder: cardInfo.cardHolder,          } : undefined,        },      });      if (error) {        // Handle specific payment errors        if (error.message.includes('INSUFFICIENT_FUNDS')) {          toast({            title: '❌ Fonduri insuficiente',            description: 'Cardul nu are suficienți bani. Verificați soldul sau folosiți alt card.',            variant: 'destructive',          });          setProcessing(false);          return;        }        if (error.message.incl...
)}                  {/* Locker Selection */}                  {paymentMethod === 'cod' && isRomanianSeller && deliveryType === 'locker' && (                    <LockerSelector                      selectedCourier={selectedCourier}                      selectedLocker={selectedLocker}                      onLockerSelect={setSelectedLocker}                      isCOD={true}                    />                  )}                  {/* Card Payment Details */}                  {paymentMethod === 'card' && (                    <Card>                      <CardHeader>                        <CardTitle className="flex items-center gap-2">                          <CreditCard className="h-5 w-5" />                          Detalii Card                          {detectedCardType && detectedCardType !== 'Unknown' && (                            <Badge variant="secondary" className="ml-2 text-xs">                              {detectedCardType}                            </...
